# poll モジュール

ランダムなテーマでアンケートを自動投稿し、結果を集計・記憶するモジュール。

---

## 処理フロー

```mermaid
flowchart TD
    subgraph 自動投稿
        A["30分間隔ポーリング"] --> B{"投稿確率チェック"}
        B -- スキップ --> Z["何もしない"]
        B -- 投稿 --> C["テーマ選択\n（50種以上からランダム）"]
        C --> D["vocabulary からアイテム生成"]
        D --> E{"前回の勝者あり?"}
        E -- あり --> F["勝者を選択肢に追加"]
        E -- なし --> G["投票付きノート投稿"]
        F --> G
        G --> H["タイマーセット"]
    end

    subgraph 結果集計
        H --> I["タイムアウト後"]
        I --> J["投票結果を取得"]
        J --> K{"最多得票は?"}
        K -- 0票 --> L["activeFactor減少"]
        K -- 単独1位 --> M["結果発表\n+ 記憶"]
        K -- 同率1位 --> N["結果発表\n+ ランダムに1つ記憶"]
    end
```

---

## 投稿タイミング

| 時間帯 | 投稿確率 |
|---|---|
| 0-6時 | 投稿しない |
| 7-11時 | 5% × activeFactor |
| 12時 | 25% × activeFactor |
| 13-16時 | 投稿しない |
| 17-23時 | 25% × activeFactor |
| 12/31 20:00-20:30 | 100%（確定） |

---

## アンケートパラメータ

| 項目 | 通常 | 大晦日 |
|---|---|---|
| 選択肢数 | 4〜9 | 10 |
| 投票受付時間 | 10分（延長あり） | 120分 |
| テーマ | ランダム | 「○○年っぽい響きのもの」 |

### 特殊テーマ

| テーマ名 | 選択肢ソース |
|---|---|
| 好きな絵文字 | インスタンスの絵文字 |
| 面白いバナナス | `makeBananasu()` |

---

## 記憶の仕組み

- 3票以上 or 総投票数 > 選択肢数の場合に結果を記憶
- 同じアイテムが連勝すると `winCount` が増加
- 連勝数が多いほど、次回の選択肢に前回の勝者が混ざりやすくなる
- 過去最高連勝記録は `pollresultlegend` に別途保存

---

## メンションコマンド

| コマンド | 権限 | 説明 |
|---|---|---|
| 覚えた答え | 誰でも | 記憶しているアンケート結果一覧を表示 |

---

## データコレクション

| コレクション名 | 用途 |
|---|---|
| `_poll_pollresult` | 現在の最多得票アイテム・連勝数 |
| `_poll_pollresultlegend` | 過去最高連勝記録 |
| `_poll_ongoingPolls` | 進行中のアンケート管理 |

---

## 依存関係

| 依存先 | 用途 |
|---|---|
| `lokijs` | 結果データの永続化 |
| `@/vocabulary` | 選択肢アイテムの生成 |
| `@/serifs` | 投稿セリフ |
